<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wise Man’s Quest</title>
    
    <!-- ADDED: Festive and Elegant Fonts --><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* UPDATED: Set the main body font to the elegant serif, Lora */
        body {
            font-family: 'Lora', serif;
            /* UPDATED: More festive and Christ-centered background */
            background-color: #e0f2f7; /* Base color for the background */
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='10' viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23d0e9f0' fill-opacity='0.4'%3E%3Cpath fill-rule='evenodd' d='M0 10V0h1L0 1zM10 10V0H9L10 1z'/%3E%3C/g%3E%3C/svg%3E"); /* Subtle star/snowflake pattern */
            background-repeat: repeat;
            overflow-x: hidden;
            box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.05); 
        }
        /* ADDED: Apply the decorative Playfair Display font to all headings for elegance */
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }

        /* Styling for the primary LLM action button */
        .llm-button {
            background-color: #006A4E; /* Deep Christmas Green */
            transition: all 0.2s ease-in-out;
        }
        .llm-button:hover:not(:disabled) {
            background-color: #004D38;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .llm-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Responsive container for the embedded video */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            cursor: pointer; /* Indicates it's clickable */
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Styles for the static preview image */
        .video-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Play button overlay */
        .play-button {
            width: 6rem;
            height: 4rem;
            background-color: rgba(255, 0, 0, 0.8);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        .play-button:hover {
            background-color: rgba(255, 0, 0, 0.95);
            transform: scale(1.05);
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-xl w-full bg-white rounded-xl shadow-2xl p-6 md:p-8 space-y-6 border border-gray-100">

        <!-- Header - Updated color to deep green for contrast --><header class="text-center space-y-2">
            <p class="text-sm font-medium text-gray-500">A Christmas Gift from the Rindlisbacher Family</p>
            <h1 class="text-3xl font-extrabold text-emerald-700 md:text-4xl">
                The Wise Man’s Star: Seeking Jesus
            </h1>
            <p class="text-gray-600 text-lg">
                The search for the Savior continues this Christmas season.
            </p>
            <div class="h-1 bg-amber-400 w-16 mx-auto rounded-full"></div>
        </header>

        <!-- Video Section (The Message) --><section class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-800">1. Watch the Message</h2>
            <div class="video-container" onclick="loadVideo()">
                
                <!-- Static Preview (Visible on load) --><div id="videoPreview" class="video-preview" style="background-image: url('https://img.youtube.com/vi/9OcQXpZwRKY/maxresdefault.jpg');">
                    <div class="play-button">
                        <!-- Play Icon (Inline SVG for reliability) --><svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>

                <!-- Video Embed (Hidden until click) --><div id="videoEmbed" class="hidden">
                    <iframe 
                        src="https://www.youtube.com/embed/9OcQXpZwRKY?autoplay=1" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>

            </div>
            <p class="text-sm text-center text-gray-500 italic">Video: Wise Men Still Seek Him, The Church of Jesus Christ of Latter-day Saints</p>
        </section>

        <!-- Instructions Section --><section class="space-y-4 pt-4">
            <h2 class="text-xl font-semibold text-gray-800">2. Complete Your Quest</h2>
            
            <p class="text-gray-700">
                The Wise Man has led you to a gift! As a thank you for seeking the Savior, please come to our porch to receive a small, Christ-centered gift.
            </p>

            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg space-y-2">
                <p class="font-bold text-lg text-amber-800 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.727A8 8 0 0115.342 16H8.658a8 8 0 01-2.314.727m12.72-1.454L15.42 5.56a2.003 2.003 0 00-3.66 0l-4.965 9.715a1 1 0 00.106.903l2.88 2.88a1 1 0 00.707.293h4.743a1 1 0 00.707-.293l2.88-2.88a1 1 0 00.106-.903z" />
                    </svg>
                    Gift Location (Pleasant View, UT)
                </p>
                <!-- Address is now fixed in the code --><a id="giftLocation" href="https://maps.app.goo.gl/YourMapLinkHere" target="_blank" class="text-gray-800 block text-center font-mono bg-white p-2 rounded-md border border-gray-300 hover:bg-gray-50 transition duration-150">
                    3196 N 1075 W, Pleasant View, UT 84414
                </a>
                <p class="text-sm text-amber-700 mt-1 italic">
                    (Please take only one gift per family.)
                </p>
            </div>

            <div class="pt-4 space-y-2">
                <h3 class="text-xl font-semibold text-gray-800">3. Continue the Search!</h3>
                <p class="text-gray-700">
                    Your mission is not over! Tomorrow night, please **re-hide the Wise Man and his lantern** somewhere new in the neighborhood for another family to find. Let's keep the Light of Christ moving!
                </p>
            </div>

        </section>

        <!-- LLM Feature Section --><hr class="border-t border-gray-200 mt-6 pt-6">
        <section class="space-y-4">
            <h2 class="text-2xl font-bold text-emerald-700 text-center">
                4. ✨ Share Your Light
            </h2>
            <p class="text-gray-600 text-center">
                Reflect on the message or plan how you will **Light the World**. Tell us your idea, and we'll polish it into an inspiring goal!
            </p>

            <textarea 
                id="reflectionPrompt" 
                rows="3" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" 
                placeholder="Example: I want to smile more at people, or, I feel grateful for my family and the Savior.">
            </textarea>

            <button id="generateButton" class="llm-button w-full text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition duration-200">
                <span id="buttonText">✨ Generate My Light the World Idea</span>
                <div id="spinner" class="spinner hidden ml-2"></div>
            </button>
            
            <div id="resultContainer" class="hidden mt-4 bg-green-50 border-l-4 border-emerald-600 p-4 rounded-lg shadow-inner">
                <p class="font-semibold text-emerald-800 mb-2">Your Guiding Light:</p>
                <p id="reflectionResult" class="text-gray-700 italic"></p>
            </div>
            
            <div id="errorContainer" class="hidden mt-4 bg-red-50 border-l-4 border-red-600 p-4 rounded-lg shadow-inner">
                <p class="font-semibold text-red-800">Error:</p>
                <p id="errorMessage" class="text-gray-700"></p>
            </div>
            
        </section>

        <!-- Footer - Updated to include family name --><footer class="text-center pt-6 text-sm text-gray-500 border-t border-gray-100">
            Merry Christmas and Happy Seeking from the Rindlisbacher Family!
        </footer>
    </div>

    <!-- Firebase and LLM API Logic --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Function to handle loading the video on click
        window.loadVideo = function() {
            const preview = document.getElementById('videoPreview');
            const embed = document.getElementById('videoEmbed');
            
            // Hide the static image preview
            preview.classList.add('hidden');
            
            // Show the iframe embed and start autoplay (since we appended '?autoplay=1' to the src)
            embed.classList.remove('hidden');
        };

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app); // Initialized, but not used for Firestore operations
                auth = getAuth(app);

                // 1. Handle Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Firebase user signed in:", user.uid);
                    } else {
                        // Sign in anonymously if no token is provided or if sign-in fails
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Authentication failed, attempting anonymous sign-in:", e);
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        } else {
            console.error("Firebase configuration is missing.");
        }


        // --- LLM API Logic ---
        const apiKey = ""; // Canvas environment provides API key
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        
        const reflectionPrompt = document.getElementById('reflectionPrompt');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const resultContainer = document.getElementById('resultContainer');
        const reflectionResult = document.getElementById('reflectionResult');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');

        /**
         * Fetches data with exponential backoff for retries.
         * @param {string} url - The API URL.
         * @param {object} options - Fetch options (method, headers, body).
         * @param {number} maxRetries - Maximum number of retries.
         * @returns {Promise<Response>} - The successful response object.
         */
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Rate limit hit. Retrying in ${Math.round(delay / 1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Fetch failed after max retries:", error);
                        throw error;
                    }
                }
            }
        }

        async function generateReflection() {
            const userPrompt = reflectionPrompt.value.trim();
            if (!userPrompt) {
                errorMessage.textContent = "Please enter a reflection or service idea first!";
                errorContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                return;
            }

            // UI State: Loading
            generateButton.disabled = true;
            buttonText.textContent = "Generating...";
            spinner.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            resultContainer.classList.add('hidden');
            
            // Define the System Instruction for the LLM
            const systemPrompt = `You are a warm, encouraging, and spiritually-focused Christmas reflection assistant from the Rindlisbacher family. Your task is to take a user's prompt (which might be a feeling, a thought, or an action idea) and transform it into a concise, single-paragraph statement (maximum 3 sentences) that is faith-based and Christ-centered.
            
            - If the user provides a reflection or feeling (e.g., "I feel grateful for my family"), polish it into a beautiful statement of gratitude or faith.
            - If the user provides an action idea (e.g., "I want to smile more"), refine it into a specific, actionable, and gentle way to serve or 'Light the World' this Christmas season.
            
            Do not include headings, bullet points, or any introductory phrases (like "Here is your reflection:"). Simply provide the polished text.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Use the tool for grounded search in case the user asks for specific external info (though unlikely for a reflection, it makes the model more robust)
                tools: [{ "google_search": {} }], 
            };

            try {
                const response = await exponentialBackoffFetch(`${apiUrl}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    reflectionResult.textContent = text.trim();
                    resultContainer.classList.remove('hidden');
                } else {
                    errorMessage.textContent = "Could not generate reflection. Please try a different prompt or check the console for details.";
                    errorContainer.classList.remove('hidden');
                }

            } catch (error) {
                console.error("API Call Error:", error);
                errorMessage.textContent = "A connection error occurred. Please ensure you are online and try again.";
                errorContainer.classList.remove('hidden');
            } finally {
                // UI State: Reset
                generateButton.disabled = false;
                buttonText.textContent = "✨ Generate My Light the World Idea";
                spinner.classList.add('hidden');
            }
        }

        // Event listener for the LLM button
        generateButton.addEventListener('click', generateReflection);

    </script>
</body>
</html>